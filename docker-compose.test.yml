services:
  playwright-proxy-mcp:
    build:
      context: .
      target: production
    image: playwright-proxy-mcp:latest
    container_name: playwright-proxy-mcp
    environment:
      - PW_MCP_PROXY_BROWSER=${PW_MCP_PROXY_BROWSER:-chromium}
      - PW_MCP_PROXY_HEADLESS=${PW_MCP_PROXY_HEADLESS:-true}
      - PW_MCP_PROXY_CAPS=${PW_MCP_PROXY_CAPS:-vision,pdf}
      - PW_MCP_PROXY_OUTPUT_DIR=${PW_MCP_PROXY_OUTPUT_DIR:-/app/playwright-output}
      - PW_MCP_PROXY_SAVE_SESSION=${PW_MCP_PROXY_SAVE_SESSION:-true}
      - PW_MCP_PROXY_SAVE_TRACE=${PW_MCP_PROXY_SAVE_TRACE:-false}
      - PW_MCP_PROXY_TIMEOUT_ACTION=${PW_MCP_PROXY_TIMEOUT_ACTION:-5000}
      - PW_MCP_PROXY_TIMEOUT_NAVIGATION=${PW_MCP_PROXY_TIMEOUT_NAVIGATION:-60000}
      - PW_MCP_PROXY_IMAGE_RESPONSES=${PW_MCP_PROXY_IMAGE_RESPONSES:-allow}
      - PW_MCP_PROXY_IGNORE_HTTPS_ERRORS=${PW_MCP_PROXY_IGNORE_HTTPS_ERRORS:-false}
      - PW_MCP_PROXY__DEFAULT_INSTANCES=${PW_MCP_PROXY__DEFAULT_INSTANCES:-1}
      - PW_MCP_PROXY__DEFAULT_IS_DEFAULT=${PW_MCP_PROXY__DEFAULT_IS_DEFAULT:-true}
      - BLOB_STORAGE_ROOT=${BLOB_STORAGE_ROOT:-/mnt/blob-storage}
      - BLOB_MAX_SIZE_MB=${BLOB_MAX_SIZE_MB:-500}
      - BLOB_TTL_HOURS=${BLOB_TTL_HOURS:-24}
      - BLOB_SIZE_THRESHOLD_KB=${BLOB_SIZE_THRESHOLD_KB:-50}
      - BLOB_CLEANUP_INTERVAL_MINUTES=${BLOB_CLEANUP_INTERVAL_MINUTES:-60}
      - PROXY_DEBUG=${PROXY_DEBUG:-false}
    ports:
      - "8000:8000"
    volumes:
      # Persistent blob storage
      - blob-storage:/mnt/blob-storage
      # Playwright session data, traces, videos
      - playwright-output:/app/playwright-output
    restart: unless-stopped
    # Resource limits for browser automation
    deploy:
      resources:
        limits:
          memory: 4G      # Browsers are memory-intensive
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'

volumes:
  blob-storage:
    driver: local
  playwright-output:
    driver: local
